name: PHP Linting

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:

  php-lint:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP runtime
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.3
          coverage: "none"

      - name: Lint PHP files
        continue-on-error: true
        id: lint
        run: |
          curl -Ls https://github.com/overtrue/phplint/releases/latest/download/phplint.phar -o /usr/local/bin/phplint
          chmod +x /usr/local/bin/phplint
          Result=$(/usr/local/bin/phplint --no-cache --no-progress -v -q --exclude=vendor --log-json --ignore-exit-code)
          Status=$(echo $Result | jq -r ".status")
          if [ "$Status" == "success" ]; THEN
            echo "success=true" >> "$GITHUB_OUTPUT"
          else
            echo "success=false" >> "$GITHUB_OUTPUT"
            FAILURES=$(jq ".failures")
            {
              echo "failures<<EOF"
              echo -e "$FAILURES"
              echo "EOF"
            }  >> "$GITHUB_OUTPUT"
          fi
          
      - name: Show output
        if: always()
        run: |
          eho -e "${{ steps.lint.outputs.success }}"
          echo -e "${{ steps.lint.outputs.failures }}"
